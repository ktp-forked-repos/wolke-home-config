#!/usr/bin/perl
use strict;
use warnings;

sub run(@);

sub main(@){
  my $arg = "--toggle";
  $arg = shift if @_ == 1;
  if(@_ != 0 or $arg !~ /^(--on|--off|--toggle)$/){
    die "Usage: $0 [--on|--off|--toggle]  {default is --toggle}\n";
  }

  if($arg eq "--toggle"){
    system "pkill", "-0", "klomplayer";
    $arg = ($? == 0) ? "--off" : "--on";
    print "$0 $arg\n"
  }

  if($arg eq "--off"){
    run "klomp-cmd", "stop";
    run "pkill", "-9", "-f", "klomp-bigtext";
    run "nohup pi tv >/dev/null 2>/dev/null";
    run "nohup pi bigtext -k >/dev/null 2>/dev/null &";
    run "nohup pi xscreensaver-command -activate >/dev/null 2>/dev/null &";
  }elsif($arg eq "--on"){
    run "klomp-mnt";
    run "nohup pi tv >/dev/null 2>/dev/null";
    run "pkill", "-9", "-f", "klomp-bigtext";
    run "nohup klomp-bigtext --ipmagic=raspi --ipmagic-user=pi >/dev/null 2>/dev/null &";
    run "klomp-cmd", "start";
  }
}

sub run(@){
  print "@_\n";
  system @_;
}

&main(@ARGV);
