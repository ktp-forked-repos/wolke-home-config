#!/usr/bin/perl
use strict;
use warnings;

sub checkIpmagic($);
sub run(@);

sub main(@){
  my $arg = "--toggle";
  $arg = shift if @_ == 1;
  if(@_ != 0 or $arg !~ /^(--on|--off|--toggle)$/){
    die "Usage: $0 [--on|--off|--toggle]  {default is --toggle}\n";
  }

  if($arg eq "--toggle"){
    system "pkill", "-0", "klomplayer";
    $arg = ($? == 0) ? "--off" : "--on";
    print "$0 $arg\n"
  }

  if($arg eq "--off"){
    run "klomp-cmd", "stop";
    run "pkill", "-9", "-f", "klomp-bigtext";
    if(checkIpmagic("raspi")){
      run "pi tv";
      run "pi bigtext -k";
      run "pi pkill unclutter";
      run "pi xscreensaver-command -activate";
    }
  }elsif($arg eq "--on"){
    run "klomp-mnt";
    run "klomp-cmd", "start";
    run "pkill", "-9", "-f", "klomp-bigtext";
    if(checkIpmagic("raspi")){
      run "pi tv &";
      run "nohup klomp-bigtext --ipmagic=raspi --ipmagic-user=pi >/dev/null 2>/dev/null &";
      run "pi 'nohup unclutter >/dev/null 2>/dev/null'";
    }
  }
}

sub checkIpmagic($){
  run "execPing --timeout=5 --ipmagic=$_[0]";
  return $? == 0;
}

sub run(@){
  print "@_\n";
  system @_;
}

&main(@ARGV);
