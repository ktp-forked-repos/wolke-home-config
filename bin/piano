#!/usr/bin/perl
use strict;
use warnings;
use Time::HiRes qw(sleep);

my $soundFont = "$ENV{HOME}/Music/soundfonts/PC51d.sf2";
my $config = "$ENV{HOME}/.config/vmpk.sourceforge.net/Virtual MIDI Piano Keyboard.conf";
my $keyboardMapFile = "$ENV{HOME}/.config/vmpk.sourceforge.net/customkb.conf";

sub main(@){
  die "Usage: $0\n" if @_ != 0;

  system "killall -9 fluidsynth vmpk";

  if(`dpkg -s fluidsynth | grep Status` !~ "Status:.*ok installed\n"){
    die "install fluidsynth!\n";
  }
  if(`dpkg -s vmpk | grep Status` !~ "Status:.*ok installed\n"){
    die "install vmpk!\n";
  }

  if(not -e $config){
    system "alarm -s failure";
    print "\n\n\n\n!!!!!NO CONFIG FILE YET: please exit vmpk normally\n\n\n\n";
    system "vmpk";
  }

  my $seqId = 'vmpk';
  my $outport = "FLUID Synth ($seqId):0";

  my @fluidSynthArgs = (
    "-s", "-i",
    "$soundFont",
    "-o", "midi.alsa_seq.id='$seqId'",
    "-a", "pulseaudio",
    "-z", "2048",
    "-c2",
  );


  open FH, "< $config";
  my @lines = <FH>;
  close FH;
  for my $line(@lines){
    $line =~ s/^OutPort=.*/OutPort=$outport/;
    $line =~ s/^MapFile=.*/MapFile=$keyboardMapFile/;
  }
  open FH, "> $config";
  print FH @lines;
  close FH;

  system "fluidsynth @fluidSynthArgs &";
  system "sleep 0.3";
  system "vmpk &";
}

&main(@ARGV);
